<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>QR code audio live reader</title>

  <link type="text/css" rel="stylesheet" href="core/main.css">
</head>

<body>
  <div id="video-container">
    <video id="qr-video"></video>
  </div>

  <!-- <b>Detected QR code: </b>
  <span id="cam-qr-result">None</span>
  <br>
  <b>Last detected at: </b>
  <span id="cam-qr-result-timestamp"></span> -->

  <!-- <button id="start-button">Start</button>
  <button id="stop-button">Stop</button> -->

  <script src="config.js"></script>

  <script type="module">
    import QrScanner from "../core/qr-scanner.min.js";

    const video = document.getElementById('qr-video');
    const videoContainer = document.getElementById('video-container');
    const camQrResult = document.getElementById('cam-qr-result');
    const camQrResultTimestamp = document.getElementById('cam-qr-result-timestamp');

    // let previousAudio = null;
    let audio = null;
    let previousCode = null;

    function onResult(result) {
      const code = result.data;
      // console.log(code);

      let newAudio = new Audio('sounds/' + code + '.mp3');
      newAudio.onloadeddata = function () {

        // if new audio is different from previous audio
        if (previousCode != code) {

          if (audio) {
            audio.pause();
          }

          audio = newAudio;
          audio.play();
          previousCode = code;
        }
      }


      // Result
      // camQrResult.textContent = result.data;
      // camQrResultTimestamp.textContent = new Date().toString();
    }

    // ####### Web Cam Scanning #######

    const scanner = new QrScanner(video, result => onResult(result), {
      onDecodeError: error => {
        camQrResult.textContent = error;
        camQrResult.style.color = 'inherit';
      },
      preferredCamera: config.camera.camera,
      highlightScanRegion: config.camera.highlightScanRegion ?? false,
      highlightCodeOutline: config.camera.highlightQRCodeOutline ?? false,
    });

    scanner.start().then(() => {

    });

    // for debugging
    window.scanner = scanner;

    if (config.theme) {
      const detections = {
        'black-on-white': 'original',
        'white-on-black': 'invert',
        'both': 'both',
      };

      scanner.setInversionMode(detections[config.theme]);
    }

    // document.getElementById('start-button').addEventListener('click', () => {
    //   scanner.start();
    // });

    // document.getElementById('stop-button').addEventListener('click', () => {
    //   scanner.stop();
    // });
  </script>
</body>

</html>